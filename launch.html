<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒãƒã§å¤©ä½“ã¾ã§é£›ã°ãã†</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --text:#e7eefc; --muted:#a9b7d6;
      --accent:#67e8f9; --accent2:#a78bfa; --danger:#fb7185;
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background: radial-gradient(1200px 700px at 30% 20%, #182448, var(--bg));
      color:var(--text);
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:16px; }
    h1{ font-size:20px; margin:6px 0 10px; }
    .grid{ display:grid; grid-template-columns: 1.35fr .65fr; gap:12px;}
    .card{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
      box-shadow:0 12px 32px rgba(0,0,0,.25);
    }

    /* â˜… canvasä¸Šã§ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯è¨±å¯ï¼ˆpan-yï¼‰ */
    canvas{
      width:100%;
      height:520px;
      background: rgba(255,255,255,.02);
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      touch-action: pan-y;
      display:block;
    }

    label{ display:block; font-size:12px; color:var(--muted); margin-top:10px; margin-bottom:4px;}
    input[type="range"]{ width:100%; }
    .row{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.03); }
    .btn{
      cursor:pointer; border:none; color:var(--text); font-weight:800;
      padding:10px 12px; border-radius:12px;
      background: linear-gradient(135deg, rgba(103,232,249,.35), rgba(167,139,250,.25));
    }
    .btn:active{ transform: translateY(1px); }
    .small{ font-size:12px; color:var(--muted); line-height:1.5; }
    .meter{ height:10px; border-radius:999px; background: rgba(255,255,255,.10); overflow:hidden; }
    .meter > div{ height:100%; width:0%; background: linear-gradient(90deg, var(--accent), var(--accent2)); }
    .stat{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;}
    .box{ padding:10px; border-radius:14px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.03); }
    .num{ font-size:18px; font-weight:900; margin-top:2px;}
    .hint{ margin-top:10px; padding:10px; border-radius:14px; border:1px dashed rgba(255,255,255,.18); color:var(--muted); }

    /* ã‚¹ãƒãƒ›å¯¾å¿œï¼šç¸¦ä¸¦ã³ã«ã™ã‚‹ */
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
      canvas { height: 72vh; min-height: 420px; } /* ã¡ã‚‡ã„åºƒã‚ */
      .card:last-child { order: 2; }
      .card:first-child { order: 1; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸš€ ãƒãƒã‚’å¤©ä½“ã¾ã§é£›ã°ãã†ï¼ˆãƒ‡ãƒ¢ç‰©ç†ï¼‰</h1>
  <div class="grid">
    <div class="card">
      <canvas id="c"></canvas>
      <div class="hint">
        æ“ä½œï¼šç™ºå°„å°ã®ãƒãƒ–ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦æŠ¼ã—è¾¼ã‚€ â†’ é›¢ã™ã¨ç™ºå°„ã€‚<br>
        ãƒãƒ–ã‚’æ´ã‚“ã§ã„ã‚‹é–“ã ã‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å›ºå®šï¼ˆãã‚Œä»¥å¤–ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«OKï¼‰ã€‚
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="pill">ğŸ¯ ç›®æ¨™ï¼š<b id="goalName">â€”</b></div>
        <button class="btn" id="nextGoal">æ¬¡ã®å¤©ä½“</button>
      </div>

      <label>ç·šå¾„ dï¼ˆå¤ªã„ã»ã©ç¡¬ã„ï¼‰</label>
      <input id="d" type="range" min="0.6" max="3.0" step="0.1" value="1.2">
      <div class="small">d = <b id="dLabel">1.2</b></div>

      <label>ã‚³ã‚¤ãƒ«å¾„ Dï¼ˆå¤§ãã„ã»ã©æŸ”ã‚‰ã‹ã„ï¼‰</label>
      <input id="D" type="range" min="6" max="40" step="1" value="16">
      <div class="small">D = <b id="DLabel">16</b></div>

      <label>æœ‰åŠ¹å·»æ•° nï¼ˆå¤šã„ã»ã©æŸ”ã‚‰ã‹ã„ï¼‰</label>
      <input id="n" type="range" min="2" max="18" step="1" value="8">
      <div class="small">n = <b id="nLabel">8</b></div>

      <div class="stat">
        <div class="box">
          <div class="small">ãƒãƒå®šæ•°ã£ã½ã„ kï¼ˆéŠã³ç”¨ï¼‰</div>
          <div class="num" id="kLabel">â€”</div>
        </div>
        <div class="box">
          <div class="small">æŠ¼ã—è¾¼ã¿ xï¼ˆpxï¼‰</div>
          <div class="num"><span id="xLabel">0</span></div>
        </div>
      </div>

      <div style="margin-top:10px;">
        <div class="row"><div class="small">ç™ºå°„ãƒ‘ãƒ¯ãƒ¼</div><div class="small" id="status">â€”</div></div>
        <div class="meter"><div id="pBar"></div></div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn" id="reset">ãƒªã‚»ãƒƒãƒˆ</button>
        <button class="btn" id="toggleAssist">è§’åº¦ã‚¢ã‚·ã‚¹ãƒˆï¼šON</button>
      </div>

      <div class="small" style="margin-top:12px;">
        ãƒ»å¼ã¯æ•™è‚²ç”¨ã®ã€Œãã‚Œã£ã½ã•ã€ã§ã™ï¼ˆç²¾å¯†è¨­è¨ˆã§ã¯ãªã„ï¼‰ã€‚<br>
        ãƒ»å¤©ä½“ã¯ãƒ©ãƒ³ãƒ€ãƒ ä½ç½®ã«å‡ºã¾ã™ï¼ˆå¤©ä½“ã”ã¨ã«ã‚µã‚¤ã‚ºã¯å›ºå®šï¼‰ã€‚
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");

  const dEl = document.getElementById("d");
  const DEl = document.getElementById("D");
  const nEl = document.getElementById("n");
  const dLabel = document.getElementById("dLabel");
  const DLabel = document.getElementById("DLabel");
  const nLabel = document.getElementById("nLabel");
  const kLabel = document.getElementById("kLabel");
  const xLabel = document.getElementById("xLabel");
  const pBar = document.getElementById("pBar");
  const statusEl = document.getElementById("status");

  const resetBtn = document.getElementById("reset");
  const nextGoalBtn = document.getElementById("nextGoal");
  const goalNameEl = document.getElementById("goalName");
  const toggleAssistBtn = document.getElementById("toggleAssist");

  let assist = true;
  let dpr = 1;

  function resize(){
    const r = canvas.getBoundingClientRect();
    dpr = Math.max(1, Math.min(2.5, window.devicePixelRatio || 1));
    canvas.width = Math.floor(r.width * dpr);
    canvas.height = Math.floor(r.height * dpr);
    // ä»¥å¾Œã®æç”»ã¯ã€ŒCSSãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™ã€ã§æã‘ã‚‹
    ctx.setTransform(dpr,0,0,dpr,0,0);

    // ç”»é¢ã‚µã‚¤ã‚ºãŒå¤‰ã‚ã£ãŸã‚‰ã€ç™ºå°„å°ã¯ã€Œå¿…ãšä¸‹ä¸­å¤®ã€ã«å†é…ç½®
    initPositions();

    // ç›®æ¨™ãŒç”»é¢å¤–ã«å‡ºãªã„ã‚ˆã†ã€ä»Šã®å¤©ä½“ã‚‚ã‚‚ã†ä¸€åº¦å®‰å…¨ä½ç½®ã¸
    placeGoalRandom();
  }
  window.addEventListener("resize", resize);

  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const lerp  = (a,b,t)=>a+(b-a)*t;

  // -------------------------
  // Images
  // -------------------------
  const mascotImg = new Image();
  mascotImg.src = "astronaut.png";
  let mascotReady = false;
  mascotImg.onload = () => { mascotReady = true; };

  // â˜…ãƒœãƒ¼ãƒ«ç”¨ãƒ­ã‚´
  const ballImg = new Image();
  ballImg.src = "logo.png";
  let ballImgReady = false;
  ballImg.onload = () => { ballImgReady = true; };

  // â˜…å¤©ä½“6æšï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã¯ã“ã“ï¼‰
  const planetImgs = {
    moon:   new Image(),
    mars:   new Image(),
    jupiter:new Image(),
    saturn: new Image(),
    uranus: new Image(),
    neptune:new Image(),
  };
  planetImgs.moon.src    = "moon.png";
  planetImgs.mars.src    = "mars.png";
  planetImgs.jupiter.src = "jupiter.png";
  planetImgs.saturn.src  = "saturn.png";
  planetImgs.uranus.src  = "uranus.png";
  planetImgs.neptune.src = "neptune.png";

  // -------------------------
  // Toy physics world
  // -------------------------
  const world = { g: 520, drag: 0.985, dt: 1/60 };

  const ball = { x:0, y:0, vx:0, vy:0, r:18, active:false }; // ãƒ­ã‚´çƒã¡ã‚‡ã„å¤§ãã‚

  const launcher = {
    baseX: 0, baseY: 0,
    axisX: 0, axisY: -1,
    restLen: 120,
    len: 120,
    minLen: 60,
    maxLen: 150,
    knobR: 16,
    dragging: false,
  };

  // é£›æ¥ç‰©ï¼ˆèƒŒæ™¯ï¼‰
  const bgImages = {
    star: new Image(),
    rocket: new Image(),
    satellite: new Image(),
    ufo: new Image(),
  };
  bgImages.star.src = "shooting_star.png";
  bgImages.rocket.src = "rocket.png";
  bgImages.satellite.src = "satellite.png";
  bgImages.ufo.src = "ufo.png";
  const bgObjects = [];

  // -------------------------
  // Goals (planets)
  // â˜…å¤©ä½“ã”ã¨ã«ã‚µã‚¤ã‚ºï¼ˆå½“ãŸã‚Šåˆ¤å®šåŠå¾„ï¼‰ã‚’å¤‰ãˆã‚‹
  // -------------------------
  const goals = [
    { key:"moon",    name:"æœˆ",     r: 26 },
    { key:"mars",    name:"ç«æ˜Ÿ",   r: 28 },
    { key:"jupiter", name:"æœ¨æ˜Ÿ",   r: 36 },
    { key:"saturn",  name:"åœŸæ˜Ÿ",   r: 40 },
    { key:"uranus",  name:"å¤©ç‹æ˜Ÿ", r: 34 },
    { key:"neptune", name:"æµ·ç‹æ˜Ÿ", r: 34 },
  ];
  let goalIndex = 0;

  // ç¾åœ¨ã®ã€Œç›®æ¨™å¤©ä½“ã€ã®å®Ÿä½“ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ä½ç½®ï¼‰
  const goalState = { x: 0, y: 0, r: 30, name: "â€”", key: "moon" };

  function getK(){
    const d = Number(dEl.value);
    const D = Number(DEl.value);
    const n = Number(nEl.value);
    const G = 80;
    return (G * Math.pow(d,4)) / (8 * n * Math.pow(D,3));
  }

  function currentX(){
    return Math.round(clamp(launcher.restLen - launcher.len, 0, 999));
  }

  function initPositions(){
    const w = canvas.getBoundingClientRect().width;
    const h = canvas.getBoundingClientRect().height;

    // â˜…ç™ºå°„å°ã¯å¸¸ã«ã€Œç”»é¢ä¸‹ãƒ»ä¸­å¤®ã€
    launcher.baseX = w * 0.5;
    launcher.baseY = h - 40;

    launcher.len   = launcher.restLen;
    launcher.axisX = 0;
    launcher.axisY = -1;

    ball.x = launcher.baseX;
    ball.y = launcher.baseY - launcher.restLen - ball.r - 2;
    ball.vx = 0; ball.vy = 0;
    ball.active = false;
  }

  // â˜…ç›®æ¨™ã‚’ã€Œãƒ©ãƒ³ãƒ€ãƒ ä½ç½®ã€ã«ç½®ãï¼ˆãŸã ã—è¿‘ã™ã/ç«¯ã™ãç¦æ­¢ï¼‰
  function placeGoalRandom(){
    const w = canvas.getBoundingClientRect().width;
    const h = canvas.getBoundingClientRect().height;

    const margin = 26;             // ç”»é¢ç«¯ã‹ã‚‰ã®ä½™ç™½
    const safeBottom = 130;        // åœ°é¢/ç™ºå°„å°ã®è¿‘ãã‚’é¿ã‘ã‚‹
    const g = goals[goalIndex];
    const r = g.r;

    // ç½®ã‘ã‚‹ç¯„å›²ï¼ˆä¸Šã¯å°‘ã—ä½™è£•ã€ä¸‹ã¯ç™ºå°„å°ä»˜è¿‘ã‚’é¿ã‘ã‚‹ï¼‰
    const minX = margin + r;
    const maxX = w - (margin + r);
    const minY = margin + r;
    const maxY = Math.max(minY + 10, (h - safeBottom) - r);

    // ç™ºå°„å°ã‹ã‚‰è¿‘ã™ããªã„ã‚ˆã†ã«ã™ã‚‹
    const lx = launcher.baseX;
    const ly = launcher.baseY - launcher.restLen; // ã ã„ãŸã„ãƒãƒä¸Šç«¯ä»˜è¿‘
    const minDist = 220; // è¿‘ã™ãã‚‹ã¨å³ã‚¯ãƒªã‚¢ã«ãªã‚ŠãŒã¡ãªã®ã§

    let x= w*0.75, y= h*0.45;
    for(let t=0; t<40; t++){
      const rx = minX + Math.random() * (maxX - minX);
      const ry = minY + Math.random() * (maxY - minY);
      const d  = Math.hypot(rx - lx, ry - ly);
      if(d >= minDist){
        x = rx; y = ry;
        break;
      }
      // 40å›ã‚„ã£ã¦ç„¡ç†ãªã‚‰æœ€å¾Œã®å€¤ã§å¦¥å”ï¼ˆç”»é¢ãŒæ¥µç«¯ã«å°ã•ã„å ´åˆï¼‰
      x = rx; y = ry;
    }

    goalState.x = x;
    goalState.y = y;
    goalState.r = r;
    goalState.name = g.name;
    goalState.key = g.key;

    goalNameEl.textContent = g.name;
  }

  function setGoal(i){
    goalIndex = (i + goals.length) % goals.length;
    placeGoalRandom();
  }

  nextGoalBtn.addEventListener("click", ()=> setGoal(goalIndex + 1));

  resetBtn.addEventListener("click", ()=>{
    initPositions();
    placeGoalRandom();
    statusEl.textContent = "ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ";
  });

  toggleAssistBtn.addEventListener("click", ()=>{
    assist = !assist;
    toggleAssistBtn.textContent = `è§’åº¦ã‚¢ã‚·ã‚¹ãƒˆï¼š${assist ? "ON" : "OFF"}`;
  });

  function pointerPos(e){
    const r = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: clientX - r.left, y: clientY - r.top };
  }

  function knobPos(){
    return {
      x: launcher.baseX + launcher.axisX * launcher.len,
      y: launcher.baseY + launcher.axisY * launcher.len
    };
  }

  function hitKnob(p){
    const k = knobPos();
    const dx = p.x - k.x, dy = p.y - k.y;
    return (dx*dx + dy*dy) <= (launcher.knobR + 10) * (launcher.knobR + 10);
  }

  function setFromPointer(p){
    let dx = p.x - launcher.baseX;
    let dy = p.y - launcher.baseY;

    dy = Math.min(dy, -30); // åŸºæœ¬ã¯ä¸Šæ–¹å‘

    let len = Math.hypot(dx,dy);
    if(len < 1) len = 1;

    let ax = dx/len;
    let ay = dy/len;

    const maxDeg = assist ? 18 : 25;
    const max = maxDeg * Math.PI/180;

    let angle = Math.atan2(ax, -ay); // 0=çœŸä¸Š
    angle = clamp(angle, -max, max);

    launcher.axisX = Math.sin(angle);
    launcher.axisY = -Math.cos(angle);

    const proj = dx*launcher.axisX + dy*launcher.axisY;
    launcher.len = clamp(proj, launcher.minLen, launcher.restLen);
  }

  // -------------------------
  // é£›æ¥ç‰©ï¼ˆ4ç¨®ï¼‰ â€»å‰ã®ã¾ã¾ï¼ˆãŠã¾ã‘ï¼‰
  // -------------------------
  function spawnShootingStar(){
    const w = canvas.getBoundingClientRect().width;
    const angle = (225 + (-15 + Math.random()*30)) * Math.PI/180;
    const speed = (380 + Math.random()*260) * 0.5;
    const life = 6.0;
    bgObjects.push({
      type:"star",
      x: w * (0.65 + Math.random()*0.35),
      y: -20,
      vx: Math.cos(angle)*speed,
      vy: Math.sin(angle)*speed,
      life, maxLife: life,
      size: 44*3, alpha: 1
    });
  }
  function spawnRocket(){
    const w = canvas.getBoundingClientRect().width;
    const h = canvas.getBoundingClientRect().height;
    const life = 7.0;
    bgObjects.push({
      type:"rocket",
      x: Math.random()*w,
      y: h + 10,
      vx: (-80 + Math.random()*160) * 0.5,
      vy: (-420 - Math.random()*260) * 0.5,
      life, alpha: 1, size: 44*3
    });
  }
  function spawnSatellite(){
    const h = canvas.getBoundingClientRect().height;
    const life = 8.0;
    bgObjects.push({
      type:"satellite",
      x: -30,
      y: Math.random()*h*0.55,
      vx: (260 + Math.random()*220) * 0.5,
      vy: (60 + Math.random()*90) * 0.5,
      life, alpha: 1, size: 44*3
    });
  }
  function spawnUFO(){
    const w = canvas.getBoundingClientRect().width;
    const h = canvas.getBoundingClientRect().height;
    const life = 6 + Math.random()*6;
    bgObjects.push({
      type:"ufo",
      x: Math.random()*w,
      y: Math.random()*h*0.55,
      vx: (-240 + Math.random()*480) * 0.5,
      vy: (-180 + Math.random()*360) * 0.5,
      life, alpha: 1, fade: true, size: 62*3
    });
  }
  setInterval(() => {
    const count = Math.random() < 0.35 ? 2 : 1;
    for(let i=0;i<count;i++){
      const r = Math.random();
      if(r < 0.25) spawnShootingStar();
      else if(r < 0.5) spawnRocket();
      else if(r < 0.75) spawnSatellite();
      else spawnUFO();
    }
  }, 5000);

  // -------------------------
  // Launch
  // -------------------------
  function launch(){
    const x = currentX();
    if(x <= 0) return;

    const k = getK();
    const E = 0.5 * k * (x*x);
    let v = Math.sqrt((2*E) / 1.0);

    v *= 1100;
    v = Math.min(v, 1600);

    ball.active = true;
    ball.x = launcher.baseX + launcher.axisX*(launcher.restLen + ball.r + 2);
    ball.y = launcher.baseY + launcher.axisY*(launcher.restLen + ball.r + 2);
    ball.vx = launcher.axisX * v;
    ball.vy = launcher.axisY * v;

    statusEl.textContent = "ç™ºå°„ï¼";
  }

  // -------------------------
  // Mouse events
  // -------------------------
  canvas.addEventListener("mousedown", (e)=>{
    const p = pointerPos(e);
    if(hitKnob(p)){
      launcher.dragging = true;
      if(!ball.active){
        ball.x = launcher.baseX + launcher.axisX*(launcher.restLen + ball.r + 2);
        ball.y = launcher.baseY + launcher.axisY*(launcher.restLen + ball.r + 2);
      }
    }
  });

  window.addEventListener("mousemove", (e)=>{
    if(!launcher.dragging) return;
    setFromPointer(pointerPos(e));
  });

  window.addEventListener("mouseup", ()=>{
    if(!launcher.dragging) return;
    launcher.dragging = false;
    launch();
    launcher.len = launcher.restLen;
    launcher.axisX = 0;
    launcher.axisY = -1;
  });

  // -------------------------
  // Touch eventsï¼ˆâ˜…ãƒãƒ–ã®æ™‚ã ã‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å›ºå®šï¼‰
  // -------------------------
  canvas.addEventListener("touchstart", (e)=>{
    const p = pointerPos(e);
    if(hitKnob(p)){
      launcher.dragging = true;
      e.preventDefault(); // ãƒãƒ–æ´ã‚“ã ç¬é–“ã ã‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–‹å§‹ã‚’æ­¢ã‚ã‚‹

      if(!ball.active){
        ball.x = launcher.baseX + launcher.axisX*(launcher.restLen + ball.r + 2);
        ball.y = launcher.baseY + launcher.axisY*(launcher.restLen + ball.r + 2);
      }
    }
  }, {passive:false});

  canvas.addEventListener("touchmove", (e)=>{
    if(!launcher.dragging) return; // ãƒãƒ–ä»¥å¤–ã¯æ™®é€šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã‚‹
    e.preventDefault();            // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã ã‘å›ºå®š
    setFromPointer(pointerPos(e));
  }, {passive:false});

  window.addEventListener("touchend", ()=>{
    if(!launcher.dragging) return;
    launcher.dragging = false;
    launch();
    launcher.len = launcher.restLen;
    launcher.axisX = 0;
    launcher.axisY = -1;
  });

  // -------------------------
  // UI label updates
  // -------------------------
  function updateUI(){
    dLabel.textContent = dEl.value;
    DLabel.textContent = DEl.value;
    nLabel.textContent = nEl.value;

    const k = getK();
    kLabel.textContent = (k*1e5).toFixed(1);

    const x = currentX();
    xLabel.textContent = x;

    const power = clamp((k*1e5) * (x/90), 0, 120);
    pBar.style.width = `${clamp(power,0,100)}%`;

    if(!ball.active && !launcher.dragging) statusEl.textContent = "ãƒãƒ–ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦æŠ¼ã—è¾¼ã‚“ã§ã­";
  }

  // -------------------------
  // Step
  // -------------------------
  function step(){
    const w = canvas.getBoundingClientRect().width;
    const h = canvas.getBoundingClientRect().height;

    // ball physics
    if(ball.active){
      const dt = world.dt;
      ball.vy += world.g * dt;
      ball.vx *= world.drag;
      ball.vy *= world.drag;
      ball.x += ball.vx * dt;
      ball.y += ball.vy * dt;

      if(ball.x < -220 || ball.x > w+220 || ball.y < -320 || ball.y > h+320){
        ball.active = false;
        statusEl.textContent = "ç”»é¢å¤–ï¼ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚‚ã†ä¸€å›ï¼";
        initPositions();
      }
    } else {
      if(launcher.dragging){
        ball.x = launcher.baseX + launcher.axisX*(launcher.restLen + ball.r + 2);
        ball.y = launcher.baseY + launcher.axisY*(launcher.restLen + ball.r + 2);
      }
    }

    // bg objects update
    for(let i = bgObjects.length-1; i >= 0; i--){
      const o = bgObjects[i];
      o.x += o.vx * world.dt;
      o.y += o.vy * world.dt;
      o.life -= world.dt;

      if(o.type !== "ufo") o.vy += 30 * world.dt;

      if(o.type === "ufo" && o.fade){
        o.alpha = Math.max(0, Math.min(1, o.life / 2));
      }
      if(o.type === "star"){
        const t = Math.max(0, o.life / o.maxLife);
        o.alpha = t;
        o.size = Math.max(12, o.size * 0.985);
      }
      if(o.life <= 0 || o.x < -420 || o.x > w+420 || o.y < -420 || o.y > h+420){
        bgObjects.splice(i,1);
      }
    }

    // win checkï¼ˆãƒ©ãƒ³ãƒ€ãƒ ä½ç½®ã® goalState ã‚’ä½¿ã†ï¼‰
    const dx = ball.x - goalState.x;
    const dy = ball.y - goalState.y;
    if(Math.hypot(dx,dy) <= goalState.r + ball.r){
      ball.active = false;
      statusEl.textContent = `ğŸ‰ ${goalState.name} åˆ°é”ï¼ æ¬¡ã®å¤©ä½“ã¸ï¼`;
      setGoal(goalIndex + 1);
      initPositions();
    }
  }

  // -------------------------
  // Draw
  // -------------------------
  function draw(){
    const w = canvas.getBoundingClientRect().width;
    const h = canvas.getBoundingClientRect().height;

    ctx.clearRect(0,0,w,h);

    // starsï¼ˆå…ˆã«æãï¼‰
    ctx.globalAlpha = 0.35;
    ctx.fillStyle = "white";
    for(let i=0;i<70;i++){
      const x = (i*97)%w;
      const y = (i*53)%h;
      ctx.fillRect(x, y, 1, 1);
    }
    ctx.globalAlpha = 1;

    // bg objectsï¼ˆå½“ãŸã‚Šåˆ¤å®šãªã—ï¼‰
    bgObjects.forEach(o => {
      const img = bgImages[o.type];
      if(!img) return;
      const size = o.size ?? ((o.type === "ufo") ? 62*3 : 44*3);
      ctx.save();
      ctx.globalAlpha = (o.alpha ?? 1);
      ctx.drawImage(img, o.x, o.y, size, size);
      ctx.restore();
    });

    // goalï¼ˆå¤©ä½“ç”»åƒï¼‹ãµã‚ã£ã¨å…‰ï¼‰
    const gpImg = planetImgs[goalState.key];
    const gr = goalState.r;

    // glow
    ctx.save();
    ctx.globalAlpha = 0.25;
    ctx.fillStyle = "rgba(103,232,249,1)";
    ctx.beginPath();
    ctx.arc(goalState.x, goalState.y, gr*1.35, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();

    // planet image (å††ã§ã‚¯ãƒªãƒƒãƒ—ã—ã¦æç”»)
    if(gpImg && gpImg.complete && gpImg.naturalWidth > 0){
      ctx.save();
      ctx.beginPath();
      ctx.arc(goalState.x, goalState.y, gr, 0, Math.PI*2);
      ctx.clip();
      ctx.drawImage(gpImg, goalState.x - gr, goalState.y - gr, gr*2, gr*2);
      ctx.restore();
    } else {
      // ç”»åƒãŒã¾ã ãªã‚‰ç°¡æ˜“å††
      ctx.fillStyle = "rgba(103,232,249,.22)";
      ctx.strokeStyle = "rgba(103,232,249,.8)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(goalState.x, goalState.y, gr, 0, Math.PI*2);
      ctx.fill(); ctx.stroke();
    }

    // label
    ctx.fillStyle = "rgba(231,238,252,.92)";
    ctx.font = "800 16px system-ui";
    ctx.fillText(goalState.name, goalState.x - gr, goalState.y - gr - 10);

    // ground line
    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(0, h-20);
    ctx.lineTo(w, h-20);
    ctx.stroke();

    // launcher base
    ctx.fillStyle = "rgba(255,255,255,.07)";
    ctx.strokeStyle = "rgba(255,255,255,.18)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.roundRect(launcher.baseX-70, launcher.baseY-18, 140, 36, 10);
    ctx.fill(); ctx.stroke();

    // spring
    const top = {x: launcher.baseX, y: launcher.baseY};
    const end = knobPos();
    const total = Math.hypot(end.x-top.x, end.y-top.y);
    const coils = 11;
    const segs = coils*10;

    const dirX = (end.x-top.x)/Math.max(1,total);
    const dirY = (end.y-top.y)/Math.max(1,total);
    const perpX = -dirY;
    const perpY = dirX;

    const amp = 10 + (Number(DEl.value)/40)*14;

    ctx.strokeStyle = "rgba(167,139,250,.85)";
    ctx.lineWidth = 6;
    ctx.lineCap = "round";
    ctx.beginPath();
    for(let i=0;i<=segs;i++){
      const t = i/segs;
      const baseX = lerp(top.x, end.x, t);
      const baseY = lerp(top.y, end.y, t);
      const phase = t * coils * Math.PI*2;
      const wobble = Math.sin(phase) * amp;
      const x = baseX + perpX*wobble;
      const y = baseY + perpY*wobble;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    // knob
    ctx.fillStyle = "rgba(103,232,249,.9)";
    ctx.strokeStyle = "rgba(255,255,255,.55)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(end.x,end.y,launcher.knobR,0,Math.PI*2);
    ctx.fill(); ctx.stroke();

    // ballï¼ˆlogo.png ã‚’ä¸¸ãæç”»ï¼‰
    if (ballImgReady) {
      ctx.save();
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
      ctx.clip();
      ctx.drawImage(ballImg, ball.x - ball.r, ball.y - ball.r, ball.r * 2, ball.r * 2);
      ctx.restore();
    } else {
      ctx.fillStyle = "#fff";
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
      ctx.fill();
    }

    // helper arrow
    if(launcher.dragging){
      ctx.strokeStyle = "rgba(103,232,249,.65)";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(launcher.baseX, launcher.baseY);
      ctx.lineTo(
        launcher.baseX + launcher.axisX*(launcher.restLen+30),
        launcher.baseY + launcher.axisY*(launcher.restLen+30)
      );
      ctx.stroke();
    }

    // mascotï¼ˆå³ä¸‹ï¼‰
    if (mascotReady) {
      const mw = 90;
      const mh = mw;
      const mx = w - mw - 18;
      const my = h - mh - 28;
      ctx.save();
      ctx.globalAlpha = 0.85;
      ctx.drawImage(mascotImg, mx, my, mw, mh);
      ctx.restore();
    }
  }

  function loop(){
    updateUI();
    step();
    draw();
    requestAnimationFrame(loop);
  }

  // init
  resize();      // â†resizeå†…ã§ initPositions + placeGoalRandom ã¾ã§ã‚„ã‚‹
  setGoal(0);    // å¿µã®ãŸã‚åå‰åæ˜ 
  statusEl.textContent = "ãƒãƒ–ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦æŠ¼ã—è¾¼ã‚“ã§ã­";
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
